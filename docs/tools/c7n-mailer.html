

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>c7n-mailer: Custodian Mailer &mdash; Cloud Custodian  documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/c1_labs.ico"/>
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript" src="../_static/js/expand.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/expand.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="AWS Retroactive Tagging Resource Creators" href="c7n-trailcreator.html" />
    <link rel="prev" title="c7n-policystream: Policy Changes from Git" href="c7n-policystream.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Cloud Custodian
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../overview.html">Cloud Custodian</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart/usage.html">Monitoring your environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filters.html">Generic Filters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart/advanced.html">Advanced Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart/policyStructure.html">Example tag compliance policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/glossary.html">Basic concepts and terms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/deployment.html">Deployment</a></li>
</ul>
<p class="caption"><span class="caption-text">AWS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../aws/gettingstarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aws/examples/index.html">Example Policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aws/policy/index.html">Filters and Actions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filters.html">Generic Filters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aws/aws-modes.html">AWS Modes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aws/policy/lambda.html">Lambda Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aws/policy/mu.html">Mu - Lambda Lifecycle Management</a></li>
</ul>
<p class="caption"><span class="caption-text">Azure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../azure/gettingstarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../azure/authentication.html">Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../azure/authentication.html#azure-storage-access">Azure Storage access</a></li>
<li class="toctree-l1"><a class="reference internal" href="../azure/examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../azure/policy/index.html">Policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../azure/azure-modes.html">Azure Modes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../azure/advanced/index.html">Advanced Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../azure/contribute.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../azure/contribute.html#adding-new-azure-resources">Adding New Azure Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../azure/contribute.html#testing">Testing</a></li>
</ul>
<p class="caption"><span class="caption-text">GCP</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../gcp/gettingstarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gcp/gcp-modes.html">GCP Modes</a></li>
</ul>
<p class="caption"><span class="caption-text">Tools</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="c7n-org.html">c7n-org: Multi Account Custodian Execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="c7n-policystream.html">c7n-policystream: Policy Changes from Git</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">c7n-mailer: Custodian Mailer</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#message-relay">Message Relay</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tutorial">Tutorial</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#email">Email:</a></li>
<li class="toctree-l3"><a class="reference internal" href="#datadog">DataDog:</a></li>
<li class="toctree-l3"><a class="reference internal" href="#slack">Slack:</a></li>
<li class="toctree-l3"><a class="reference internal" href="#now-run">Now run:</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#usage-configuration">Usage &amp; Configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#standard-lambda-function-config">Standard Lambda Function Config</a></li>
<li class="toctree-l3"><a class="reference internal" href="#standard-azure-functions-config">Standard Azure Functions Config</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mailer-infrastructure-config">Mailer Infrastructure Config</a></li>
<li class="toctree-l3"><a class="reference internal" href="#datadog-config">DataDog Config</a></li>
<li class="toctree-l3"><a class="reference internal" href="#slack-config">Slack Config</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sendgrid-config">SendGrid Config</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sdk-config">SDK Config</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#configuring-a-policy-to-send-email">Configuring a policy to send email</a></li>
<li class="toctree-l2"><a class="reference internal" href="#using-on-azure">Using on Azure</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#deploying-azure-functions">Deploying Azure Functions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#writing-an-email-template">Writing an email template</a></li>
<li class="toctree-l2"><a class="reference internal" href="#developer-install-os-x-el-capitan">Developer Install (OS X El Capitan)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#testing-templates-and-recipients">Testing Templates and Recipients</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="c7n-trailcreator.html">AWS Retroactive Tagging Resource Creators</a></li>
</ul>
<p class="caption"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contribute.html">Contributing to Cloud Custodian</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer/index.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer/installing.html">Installing for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer/tests.html">Testing for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer/documentation.html">Documentation For Developers</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Cloud Custodian</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>c7n-mailer: Custodian Mailer</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="c7n-mailer-custodian-mailer">
<h1>c7n-mailer: Custodian Mailer<a class="headerlink" href="#c7n-mailer-custodian-mailer" title="Permalink to this headline">¶</a></h1>
<p>A mailer implementation for Custodian. Outbound mail delivery is still somewhat
organization-specific, so this at the moment serves primarily as an example
implementation.</p>
<blockquote>
<div><p>The Cloud Custodian Mailer can now be easily run in a Docker container. Click <a class="reference external" href="https://hub.docker.com/r/cloudcustodian/mailer">here</a> for details.</p>
</div></blockquote>
<div class="section" id="message-relay">
<h2>Message Relay<a class="headerlink" href="#message-relay" title="Permalink to this headline">¶</a></h2>
<p>Custodian Mailer subscribes to an SQS queue, looks up users, and sends email
via SES and/or send notification to DataDog. Custodian lambda and instance policies can send to it. SQS queues
should be cross-account enabled for sending between accounts.</p>
</div>
<div class="section" id="tutorial">
<h2>Tutorial<a class="headerlink" href="#tutorial" title="Permalink to this headline">¶</a></h2>
<p>Our goal in starting out with the Custodian mailer is to install the mailer,
and run a policy that triggers an email to your inbox.</p>
<ol class="simple">
<li><p><a class="reference external" href="#developer-install-os-x-el-capitan">Install</a> the mailer on your laptop (if you are not running as a <a class="reference external" href="https://hub.docker.com/r/cloudcustodian/mailer">Docker container</a></p>
<ul class="simple">
<li><p>or use <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">c7n-mailer</span></code></p></li>
</ul>
</li>
<li><p>In your text editor, create a <code class="docutils literal notranslate"><span class="pre">mailer.yml</span></code> file to hold your mailer config.</p></li>
<li><p>In the AWS console, create a new standard SQS queue (quick create is fine).
Copy the queue URL to <code class="docutils literal notranslate"><span class="pre">queue_url</span></code> in <code class="docutils literal notranslate"><span class="pre">mailer.yml</span></code>.</p></li>
<li><p>In AWS, locate or create a role that has read access to the queue. Grab the
role ARN and set it as <code class="docutils literal notranslate"><span class="pre">role</span></code> in <code class="docutils literal notranslate"><span class="pre">mailer.yml</span></code>.</p></li>
</ol>
<p>there is different notification endpoints options, you can combine both.</p>
<div class="section" id="email">
<h3>Email:<a class="headerlink" href="#email" title="Permalink to this headline">¶</a></h3>
<p>Make sure your email address is verified in SES, and set it as
<code class="docutils literal notranslate"><span class="pre">from_address</span></code> in <code class="docutils literal notranslate"><span class="pre">mailer.yml</span></code>. By default SES is in sandbox mode where you
must
<a class="reference external" href="http://docs.aws.amazon.com/ses/latest/DeveloperGuide/verify-email-addresses.html">verify</a>
every individual recipient of emails. If need be, make an AWS support ticket to
be taken out of SES sandbox mode.</p>
<p>Your <code class="docutils literal notranslate"><span class="pre">mailer.yml</span></code> should now look something like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">queue_url</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">https://sqs.us-east-1.amazonaws.com/1234567890/c7n-mailer-test</span>
<span class="nt">role</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">arn:aws:iam::123456790:role/c7n-mailer-test</span>
<span class="nt">from_address</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">you@example.com</span>
</pre></div>
</div>
<p>(Also set <code class="docutils literal notranslate"><span class="pre">region</span></code> if you are in a region other than <code class="docutils literal notranslate"><span class="pre">us-east-1</span></code>.)</p>
<p>Now let’s make a Custodian policy to populate your mailer queue. Create a
<code class="docutils literal notranslate"><span class="pre">test-policy.yml</span></code> file with this content (update <code class="docutils literal notranslate"><span class="pre">to</span></code> and <code class="docutils literal notranslate"><span class="pre">queue</span></code> to match your
environment)</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span>  <span class="nt">policies</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">c7n-mailer-test</span>
    <span class="nt">resource</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sqs</span>
    <span class="nt">filters</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;tag:MailerTest&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">absent</span>
    <span class="nt">actions</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">notify</span>
        <span class="nt">template</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
        <span class="nt">priority_header</span><span class="p">:</span> <span class="s">&#39;2&#39;</span>
        <span class="nt">subject</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">testing the c7n mailer</span>
        <span class="nt">to</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">you@example.com</span>
        <span class="nt">transport</span><span class="p">:</span>
          <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sqs</span>
          <span class="nt">queue</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">https://sqs.us-east-1.amazonaws.com/1234567890/c7n-mailer-test</span>
</pre></div>
</div>
</div>
<div class="section" id="datadog">
<h3>DataDog:<a class="headerlink" href="#datadog" title="Permalink to this headline">¶</a></h3>
<p>The standard way to do a DataDog integration is use the
c7n integration with AWS CloudWatch and use the
<a class="reference external" href="https://docs.datadoghq.com/integrations/amazon_web_services/">DataDog integration with AWS</a>
to collect CloudWatch metrics. The mailer/messenger integration is only
for the case you don’t want or you can’t use AWS CloudWatch.</p>
<p>Note this integration requires the additional dependency of datadog python bindings:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">datadog</span>
</pre></div>
</div>
<p>Your <code class="docutils literal notranslate"><span class="pre">mailer.yml</span></code> should now look something like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">queue_url</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">https://sqs.us-east-1.amazonaws.com/1234567890/c7n-mailer-test</span>
<span class="nt">role</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">arn:aws:iam::123456790:role/c7n-mailer-test</span>
<span class="nt">datadog_api_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">XXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span>
<span class="nt">datadog_application_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">YYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY</span>
</pre></div>
</div>
<p>(Also set <code class="docutils literal notranslate"><span class="pre">region</span></code> if you are in a region other than <code class="docutils literal notranslate"><span class="pre">us-east-1</span></code>.)</p>
<p>Now let’s make a Custodian policy to populate your mailer queue. Create a
<code class="docutils literal notranslate"><span class="pre">test-policy.yml</span></code>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">policies</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">c7n-mailer-test</span>
    <span class="nt">resource</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ebs</span>
    <span class="nt">filters</span><span class="p">:</span>
     <span class="p p-Indicator">-</span> <span class="nt">Attachments</span><span class="p">:</span> <span class="p p-Indicator">[]</span>
    <span class="nt">actions</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">notify</span>
        <span class="nt">to</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">datadog://?metric_name=datadog.metric.name&amp;metric_value_tag=Size</span>
        <span class="nt">transport</span><span class="p">:</span>
          <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sqs</span>
          <span class="nt">queue</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">https://sqs.us-east-1.amazonaws.com/1234567890/c7n-mailer-test</span>
</pre></div>
</div>
<p>There is a special <code class="docutils literal notranslate"><span class="pre">to</span></code> format that specifies datadog delivery, and includes the datadog configuration via url parameters.</p>
<ul class="simple">
<li><p>metric_name: is the name of the metrics send to DataDog</p></li>
<li><p>metric_value_tag: by default the metric value send to DataDog is <code class="docutils literal notranslate"><span class="pre">1</span></code> but if you want to use one of the tags returned in the policy you can set it with the attribute <code class="docutils literal notranslate"><span class="pre">metric_value_tag</span></code>, for example in the <code class="docutils literal notranslate"><span class="pre">test-policy.yml</span></code> the value used is the size of the EBS volume. The value must be a number and it’s transformed to a float value.</p></li>
</ul>
</div>
<div class="section" id="slack">
<h3>Slack:<a class="headerlink" href="#slack" title="Permalink to this headline">¶</a></h3>
<p>The Custodian mailer supports Slack messaging as a separate notification mechanism for the SQS transport method. To enable Slack integration, you must specify a Slack token in the <code class="docutils literal notranslate"><span class="pre">slack_token</span></code> field under the <code class="docutils literal notranslate"><span class="pre">mailer.yml</span></code> file.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">queue_url</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">https://sqs.us-east-1.amazonaws.com/1234567890/c7n-mailer-test</span>
<span class="nt">role</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">arn:aws:iam::123456790:role/c7n-mailer-test</span>
<span class="nt">slack_token</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">xoxo-token123</span>
</pre></div>
</div>
<p>To enable Slack messaging, several unique fields are evaluated in the policy, as shown in the below example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">policies</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">c7n</span><span class="o">-</span><span class="n">mailer</span><span class="o">-</span><span class="n">test</span>
    <span class="n">resource</span><span class="p">:</span> <span class="n">ebs</span>
    <span class="n">filters</span><span class="p">:</span>
     <span class="o">-</span> <span class="n">Attachments</span><span class="p">:</span> <span class="p">[]</span>
    <span class="n">actions</span><span class="p">:</span>
      <span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">notify</span>
        <span class="n">slack_template</span><span class="p">:</span> <span class="n">slack</span>
        <span class="n">to</span><span class="p">:</span>
          <span class="o">-</span> <span class="n">slack</span><span class="p">:</span><span class="o">//</span><span class="n">owners</span>
          <span class="o">-</span> <span class="n">slack</span><span class="p">:</span><span class="o">//</span><span class="n">foo</span><span class="nd">@bar</span><span class="o">.</span><span class="n">com</span>
          <span class="o">-</span> <span class="n">slack</span><span class="p">:</span><span class="o">//</span><span class="c1">#custodian-test</span>
          <span class="o">-</span> <span class="n">slack</span><span class="p">:</span><span class="o">//</span><span class="n">webhook</span><span class="o">/</span><span class="c1">#c7n-webhook-test</span>
          <span class="o">-</span> <span class="n">slack</span><span class="p">:</span><span class="o">//</span><span class="n">tag</span><span class="o">/</span><span class="n">resource_tag</span>
          <span class="o">-</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">hooks</span><span class="o">.</span><span class="n">slack</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">T00000000</span><span class="o">/</span><span class="n">B00000000</span><span class="o">/</span><span class="n">XXXXXXXXXXXXXXXXXXXXXXXX</span>
        <span class="n">transport</span><span class="p">:</span>
          <span class="nb">type</span><span class="p">:</span> <span class="n">sqs</span>
          <span class="n">queue</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">sqs</span><span class="o">.</span><span class="n">us</span><span class="o">-</span><span class="n">east</span><span class="o">-</span><span class="mf">1.</span><span class="n">amazonaws</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="mi">1234567890</span><span class="o">/</span><span class="n">c7n</span><span class="o">-</span><span class="n">mailer</span><span class="o">-</span><span class="n">test</span>
</pre></div>
</div>
<p>Slack messages support use of a unique template field specified by <code class="docutils literal notranslate"><span class="pre">slack_template</span></code>. This field is unique and usage will not break
existing functionality for messages also specifying an email template in the <code class="docutils literal notranslate"><span class="pre">template</span></code> field. This field is optional, however,
and if not specified, the mailer will use the default value <code class="docutils literal notranslate"><span class="pre">slack_default</span></code>.</p>
<p>Slack integration for the mailer supports several flavors of messaging, listed below. These are not mutually exclusive and any combination of the types can be used, but the preferred method is <a class="reference external" href="https://api.slack.com/incoming-webhooks">incoming webhooks</a>.</p>
<table border="1" class="docutils">
<thead>
<tr>
<th align="center">Requires&nbsp;<code>slack_token</code></th>
<th align="left">Key</th>
<th align="left">Type</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">No</td>
<td align="left"><code>https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXXXXXX</code></td>
<td align="left">string</td>
<td align="left"><strong>(PREFERRED)</strong> Send to an <a href="https://api.slack.com/incoming-webhooks">incoming webhook</a> (the channel is defined in the webhook)</td>
</tr>
<tr>
<td align="center">Yes</td>
<td align="left"><code>slack://owners</code></td>
<td align="left">string</td>
<td align="left">Send to the recipient list generated within email delivery logic</td>
</tr>
<tr>
<td align="center">Yes</td>
<td align="left"><code>slack://foo@bar.com</code></td>
<td align="left">string</td>
<td align="left">Send to the recipient specified by email address foo@bar.com</td>
</tr>
<tr>
<td align="center">Yes</td>
<td align="left"><code>slack://#custodian-test</code></td>
<td align="left">string</td>
<td align="left">Send to the Slack channel indicated in string, i.e. #custodian-test</td>
</tr>
<tr>
<td align="center">No</td>
<td align="left"><code>slack://webhook/#c7n-webhook-test</code></td>
<td align="left">string</td>
<td align="left"><strong>(DEPRECATED)</strong> Send to a Slack webhook; appended with the target channel. <strong>IMPORTANT</strong>: <em>This requires a <code>slack_webhook</code> value defined in the <code>mailer.yml</code>.</em></td>
</tr>
<tr>
<td align="center">Yes</td>
<td align="left"><code>slack://tag/resource-tag</code></td>
<td align="left">string</td>
<td align="left">Send to target found in resource tag. Example of value in tag: https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXXXXXX</td>
</tr>
</tbody>
</table><p>Slack delivery can also be set via a resource’s tag name. For example, using “slack://tag/slack_channel” will look for a tag name of ‘slack_channel’, and if matched on a resource will deliver the message to the value of that resource’s tag:</p>
<p><code class="docutils literal notranslate"><span class="pre">slack_channel:https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXXXXXX</span></code></p>
<p>Delivery via tag has been tested with webhooks but should support all delivery methods.</p>
</div>
<div class="section" id="now-run">
<h3>Now run:<a class="headerlink" href="#now-run" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">c7n</span><span class="o">-</span><span class="n">mailer</span> <span class="o">--</span><span class="n">config</span> <span class="n">mailer</span><span class="o">.</span><span class="n">yml</span> <span class="o">--</span><span class="n">update</span><span class="o">-</span><span class="k">lambda</span> <span class="o">&amp;&amp;</span> <span class="n">custodian</span> <span class="n">run</span> <span class="o">-</span><span class="n">c</span> <span class="n">test</span><span class="o">-</span><span class="n">policy</span><span class="o">.</span><span class="n">yml</span> <span class="o">-</span><span class="n">s</span> <span class="o">.</span>
</pre></div>
</div>
<p>Note: You can set the profile via environment variable e.g. <code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">AWS_DEFAULT_PROFILE=foo</span></code></p>
<p>You should see output similar to the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(env) $ c7n-mailer --config mailer.yml --update-lambda &amp;&amp; custodian run -c test-policy.yml -s .
DEBUG:custodian.lambda:Created custodian lambda archive size: 3.01mb
2017-01-12 07:55:16,227: custodian.policy:INFO Running policy c7n-mailer-test resource: sqs region:default c7n:0.8.22.0
2017-01-12 07:55:16,229: custodian.policy:INFO policy: c7n-mailer-test resource:sqs has count:1 time:0.00
2017-01-12 07:55:18,017: custodian.actions:INFO sent message:dead-beef policy:c7n-mailer-test template:default count:1
2017-01-12 07:55:18,017: custodian.policy:INFO policy: c7n-mailer-test action: notify resources: 1 execution_time: 1.79
(env) $
</pre></div>
</div>
<p>Check the AWS console for a new Lambda named <code class="docutils literal notranslate"><span class="pre">cloud-custodian-mailer</span></code>. The
mailer runs every five minutes, so wait a bit and then look for an email in
your inbox. If it doesn’t appear, look in the lambda’s logs for debugging
information. If it does, congratulations! You are off and running with the
Custodian mailer.</p>
</div>
</div>
<div class="section" id="usage-configuration">
<h2>Usage &amp; Configuration<a class="headerlink" href="#usage-configuration" title="Permalink to this headline">¶</a></h2>
<p>Once <a class="reference external" href="#developer-install-os-x-el-capitan">installed</a> you should have a
<code class="docutils literal notranslate"><span class="pre">c7n-mailer</span></code> executable on your path:
aws</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(env) $ c7n-mailer
usage: c7n-mailer [-h] -c CONFIG
c7n-mailer: error: argument -c/--config is required
(env) $
</pre></div>
</div>
<p>Fundamentally what <code class="docutils literal notranslate"><span class="pre">c7n-mailer</span></code> does is deploy a Lambda (using
<a class="reference external" href="http://cloudcustodian.io/docs/policy/mu.html">Mu</a>) based on
configuration you specify in a YAML file.  Here is <a class="reference external" href="./c7n_mailer/cli.py#L11-L41">the
schema</a> to which the file must conform,
and here is a description of the options:</p>
<table border="1" class="docutils">
<thead>
<tr>
<th align="center">Required?</th>
<th align="left">Key</th>
<th align="left">Type</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">&#x2705;</td>
<td align="left"><code>queue_url</code></td>
<td align="left">string</td>
<td align="left">the queue to listen to for messages</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>from_address</code></td>
<td align="left">string</td>
<td align="left">default from address</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>contact_tags</code></td>
<td align="left">array of strings</td>
<td align="left">tags that we should look at for address information</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>smtp_server</code></td>
<td align="left">string</td>
<td align="left">if this is unset, aws ses is used by default. To configure your lambda role to talk to smtpd in your private vpc, see <a href="https://docs.aws.amazon.com/lambda/latest/dg/vpc.html">here</a></td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>smtp_port</code></td>
<td align="left">integer</td>
<td align="left">smtp port</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>smtp_ssl</code></td>
<td align="left">boolean</td>
<td align="left">this defaults to True</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>smtp_username</code></td>
<td align="left">string</td>
<td align="left"></td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>smtp_password</code></td>
<td align="left">string</td>
<td align="left"></td>
</tr>
</tbody>
</table><div class="section" id="standard-lambda-function-config">
<h3>Standard Lambda Function Config<a class="headerlink" href="#standard-lambda-function-config" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<thead>
<tr>
<th align="center">Required?</th>
<th align="left">Key</th>
<th align="left">Type</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"></td>
<td align="left"><code>dead_letter_config</code></td>
<td align="left">object</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>memory</code></td>
<td align="left">integer</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>region</code></td>
<td align="left">string</td>
</tr>
<tr>
<td align="center">&#x2705;</td>
<td align="left"><code>role</code></td>
<td align="left">string</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>runtime</code></td>
<td align="left">string</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>security_groups</code></td>
<td align="left">array of strings</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>subnets</code></td>
<td align="left">array of strings</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>timeout</code></td>
<td align="left">integer</td>
</tr>
</tbody>
</table></div>
<div class="section" id="standard-azure-functions-config">
<h3>Standard Azure Functions Config<a class="headerlink" href="#standard-azure-functions-config" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<thead>
<tr>
<th align="center">Required?</th>
<th align="left">Key</th>
<th align="left">Type</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"></td>
<td align="left"><code>function_properties</code></td>
<td align="left">object</td>
<td align="left">Contains <code>appInsights</code>, <code>storageAccount</code> and <code>servicePlan</code> objects</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>appInsights</code></td>
<td align="left">object</td>
<td align="left">Contains <code>name</code>, <code>location</code> and <code>resource_group_name</code> properties</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>storageAccount</code></td>
<td align="left">object</td>
<td align="left">Contains <code>name</code>, <code>location</code> and <code>resource_group_name</code> properties</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>servicePlan</code></td>
<td align="left">object</td>
<td align="left">Contains <code>name</code>, <code>location</code>, <code>resource_group_name</code>, <code>skuTier</code> and <code>skuName</code> properties</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>name</code></td>
<td align="left">string</td>
<td align="left"></td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>location</code></td>
<td align="left">string</td>
<td align="left">Default: <code>west us 2</code></td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>resource_group_name</code></td>
<td align="left">string</td>
<td align="left">Default <code>cloud-custodian</code></td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>skuTier</code></td>
<td align="left">string</td>
<td align="left">Default: <code>Basic</code></td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>skuName</code></td>
<td align="left">string</td>
<td align="left">Default: <code>B1</code></td>
</tr>
</tbody>
</table></div>
<div class="section" id="mailer-infrastructure-config">
<h3>Mailer Infrastructure Config<a class="headerlink" href="#mailer-infrastructure-config" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<thead>
<tr>
<th align="center">Required?</th>
<th align="left">Key</th>
<th align="left">Type</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"></td>
<td align="left"><code>cache_engine</code></td>
<td align="left">string</td>
<td align="left">cache engine; either sqlite or redis</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>cross_accounts</code></td>
<td align="left">object</td>
<td align="left">account to assume back into for sending to SNS topics</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>debug</code></td>
<td align="left">boolean</td>
<td align="left">debug on/off</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>ldap_bind_dn</code></td>
<td align="left">string</td>
<td align="left">eg: ou=people,dc=example,dc=com</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>ldap_bind_user</code></td>
<td align="left">string</td>
<td align="left">eg: FOO\BAR</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>ldap_bind_password</code></td>
<td align="left">string</td>
<td align="left">ldap bind password</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>ldap_bind_password_in_kms</code></td>
<td align="left">boolean</td>
<td align="left">defaults to true, most people (except capone) want to set this to false. If set to true, make sure <code>ldap_bind_password</code> contains your KMS encrypted ldap bind password as a base64-encoded string.</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>ldap_email_attribute</code></td>
<td align="left">string</td>
<td align="left"></td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>ldap_email_key</code></td>
<td align="left">string</td>
<td align="left">eg 'mail'</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>ldap_manager_attribute</code></td>
<td align="left">string</td>
<td align="left">eg 'manager'</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>ldap_uid_attribute</code></td>
<td align="left">string</td>
<td align="left"></td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>ldap_uid_regex</code></td>
<td align="left">string</td>
<td align="left"></td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>ldap_uid_tags</code></td>
<td align="left">string</td>
<td align="left"></td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>ldap_uri</code></td>
<td align="left">string</td>
<td align="left">eg 'ldaps://example.com:636'</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>redis_host</code></td>
<td align="left">string</td>
<td align="left">redis host if cache_engine == redis</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>redis_port</code></td>
<td align="left">integer</td>
<td align="left">redis port, default: 6369</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>ses_region</code></td>
<td align="left">string</td>
<td align="left">AWS region that handles SES API calls</td>
</tr>
</tbody>
</table></div>
<div class="section" id="datadog-config">
<h3>DataDog Config<a class="headerlink" href="#datadog-config" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<thead>
<tr>
<th align="center">Required?</th>
<th align="left">Key</th>
<th align="left">Type</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"></td>
<td align="left"><code>datadog_api_key</code></td>
<td align="left">string</td>
<td align="left">DataDog API key.</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>datadog_application_key</code></td>
<td align="left">string</td>
<td align="left">Datadog application key.</td>
</tr>
</tbody>
</table><p>These fields are not necessary if c7n_mailer is run in a instance/lambda/etc with the DataDog agent.</p>
</div>
<div class="section" id="slack-config">
<h3>Slack Config<a class="headerlink" href="#slack-config" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<thead>
<tr>
<th align="center">Required?</th>
<th align="left">Key</th>
<th align="left">Type</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"></td>
<td align="left"><code>slack_token</code></td>
<td align="left">string</td>
<td align="left">Slack API token</td>
</tr>
</tbody>
</table></div>
<div class="section" id="sendgrid-config">
<h3>SendGrid Config<a class="headerlink" href="#sendgrid-config" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<thead>
<tr>
<th align="center">Required?</th>
<th align="left">Key</th>
<th align="left">Type</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"></td>
<td align="left"><code>sendgrid_api_key</code></td>
<td align="left">string</td>
<td align="left">SendGrid API token</td>
</tr>
<tr>
<td align="center">SendGrid is only supported for Azure Cloud use with Azure Storage Queue currently.</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody>
</table></div>
<div class="section" id="sdk-config">
<h3>SDK Config<a class="headerlink" href="#sdk-config" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<thead>
<tr>
<th align="center">Required?</th>
<th align="left">Key</th>
<th align="left">Type</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"></td>
<td align="left"><code>http_proxy</code></td>
<td align="left">string</td>
<td align="left"></td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>https_proxy</code></td>
<td align="left">string</td>
<td align="left"></td>
</tr>
<tr>
<td align="center"></td>
<td align="left"><code>profile</code></td>
<td align="left">string</td>
<td align="left"></td>
</tr>
</tbody>
</table></div>
</div>
<div class="section" id="configuring-a-policy-to-send-email">
<h2>Configuring a policy to send email<a class="headerlink" href="#configuring-a-policy-to-send-email" title="Permalink to this headline">¶</a></h2>
<p>Outbound email can be added to any policy by including the <code class="docutils literal notranslate"><span class="pre">notify</span></code> action.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">policies</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bad-apples</span>
    <span class="nt">resource</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">asg</span>
    <span class="nt">filters</span><span class="p">:</span>
     <span class="p p-Indicator">-</span> <span class="s">&quot;tag:ASV&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">absent</span>
    <span class="nt">actions</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">notify</span>
        <span class="nt">template</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
        <span class="nt">template_format</span><span class="p">:</span> <span class="s">&#39;html&#39;</span>
        <span class="nt">priority_header</span><span class="p">:</span> <span class="s">&#39;1&#39;</span>
        <span class="nt">subject</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fix your tags</span>
        <span class="nt">to</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">resource-owner</span>
        <span class="nt">owner_absent_contact</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">foo@example.com</span>
        <span class="nt">transport</span><span class="p">:</span>
          <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sqs</span>
          <span class="nt">queue</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">https://sqs.us-east-1.amazonaws.com/80101010101/cloud-custodian-message-relay</span>
</pre></div>
</div>
<p>So breaking it down, you add an action of type <code class="docutils literal notranslate"><span class="pre">notify</span></code>. You can specify a
template that’s used to format the email; customizing templates is described
<a class="reference external" href="#writing-an-email-template">below</a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">to</span></code> list specifies the intended recipient for the email. You can specify
either an email address, an SNS topic, a Datadog Metric, or a special value. The special values
are either</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">resource-owner</span></code>, in which case the email will be sent to the listed
<code class="docutils literal notranslate"><span class="pre">OwnerContact</span></code> tag on the resource that matched the policy, or</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">event-owner</span></code> for push-based/realtime policies that will send to the user
that was responsible for the underlying event.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">priority_header</span></code> to indicate the importance of an email with <a class="reference external" href="https://www.chilkatsoft.com/p/p_471.asp">headers</a>. Different emails clients will display stars, exclamation points or flags depending on the value. Should be an string from 1 to 5.</p></li>
</ul>
<p>Both of these special values are best effort, i.e., if no <code class="docutils literal notranslate"><span class="pre">OwnerContact</span></code> tag is
specified then <code class="docutils literal notranslate"><span class="pre">resource-owner</span></code> email will not be delivered, and in the case of
<code class="docutils literal notranslate"><span class="pre">event-owner</span></code> an instance role or system account will not result in an email.</p>
<p>The optional <code class="docutils literal notranslate"><span class="pre">owner_absent_contact</span></code> list specifies email addresses to notify only if
the <code class="docutils literal notranslate"><span class="pre">resource-owner</span></code> special option was unable to find any matching owner contact
tags.</p>
<p>For reference purposes, the JSON Schema of the <code class="docutils literal notranslate"><span class="pre">notify</span></code> action:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
  <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;transport&quot;</span><span class="p">,</span> <span class="s2">&quot;to&quot;</span><span class="p">],</span>
  <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;enum&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;notify&quot;</span><span class="p">]},</span>
    <span class="nt">&quot;to&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span> <span class="nt">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">}},</span>
    <span class="nt">&quot;owner_absent_contact&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span> <span class="nt">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">}},</span>
    <span class="nt">&quot;subject&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
    <span class="nt">&quot;priority_header&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
    <span class="nt">&quot;template&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
    <span class="nt">&quot;transport&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
      <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;queue&quot;</span><span class="p">],</span>
      <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;queue&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
        <span class="nt">&quot;region&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;enum&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;sqs&quot;</span><span class="p">]}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="using-on-azure">
<h2>Using on Azure<a class="headerlink" href="#using-on-azure" title="Permalink to this headline">¶</a></h2>
<p>Requires:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">c7n_azure</span></code> package.  See <a class="reference external" href="https://cloudcustodian.io/docs/azure/gettingstarted.html#azure-install-cc">Installing Azure Plugin</a></p></li>
<li><p>SendGrid account. See <a class="reference external" href="https://docs.microsoft.com/en-us/azure/sendgrid-dotnet-how-to-send-email">Using SendGrid with Azure</a></p></li>
<li><p><a class="reference external" href="https://azure.microsoft.com/en-us/services/storage/queues/">Azure Storage Queue</a></p></li>
</ul>
<p>The mailer supports an Azure Storage Queue transport and SendGrid delivery on Azure.
Configuration for this scenario requires only minor changes from AWS deployments.</p>
<p>You will need to grant <code class="docutils literal notranslate"><span class="pre">Queue</span> <span class="pre">Data</span> <span class="pre">Contributor</span></code> role on the Queue for the identity
mailer is running under.</p>
<p>The notify action in your policy will reflect transport type <code class="docutils literal notranslate"><span class="pre">asq</span></code> with the URL
to an Azure Storage Queue.  For example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">policies</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">azure-notify</span>
    <span class="nt">resource</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">azure.resourcegroup</span>
    <span class="nt">description</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">example policy</span>
    <span class="nt">actions</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">notify</span>
        <span class="nt">template</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
        <span class="nt">priority_header</span><span class="p">:</span> <span class="s">&#39;2&#39;</span>
        <span class="nt">subject</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Hello from C7N Mailer</span>
        <span class="nt">to</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">you@youremail.com</span>
        <span class="nt">transport</span><span class="p">:</span>
          <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">asq</span>
          <span class="nt">queue</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">https://storageaccount.queue.core.windows.net/queuename</span>
</pre></div>
</div>
<p>In your mailer configuration, you’ll need to provide your SendGrid API key as well as
prefix your queue URL with <code class="docutils literal notranslate"><span class="pre">asq://</span></code> to let mailer know what type of queue it is:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">queue_url</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">asq://storageaccount.queue.core.windows.net/queuename</span>
<span class="nt">from_address</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">you@youremail.com</span>
<span class="nt">sendgrid_api_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">SENDGRID_API_KEY</span>
</pre></div>
</div>
<p>The mailer will transmit all messages found on the queue on each execution, and will retry
sending 3 times in the event of a failure calling SendGrid.  After the retries the queue
message will be discarded.</p>
<div class="section" id="deploying-azure-functions">
<h3>Deploying Azure Functions<a class="headerlink" href="#deploying-azure-functions" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">--update-lambda</span></code> CLI option will also deploy Azure Functions if you have an Azure
mailer configuration.</p>
<p><code class="docutils literal notranslate"><span class="pre">c7n-mailer</span> <span class="pre">--config</span> <span class="pre">mailer.yml</span> <span class="pre">--update-lambda</span></code></p>
<p>where <code class="docutils literal notranslate"><span class="pre">mailer.yml</span></code> may look like:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">queue_url</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">asq://storage.queue.core.windows.net/custodian</span>
<span class="nt">from_address</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">foo@mail.com</span>
<span class="nt">sendgrid_api_key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;key&gt;</span>
<span class="nt">function_properties</span><span class="p">:</span>
  <span class="nt">servicePlan</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="s">&#39;testmailer1&#39;</span>
    <span class="nt">resourceGroupName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">custodianmailer1</span>
    <span class="nt">skuTier</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Basic</span>
    <span class="nt">skuName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">B1</span>
    <span class="nt">location</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">WestUS2</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="writing-an-email-template">
<h2>Writing an email template<a class="headerlink" href="#writing-an-email-template" title="Permalink to this headline">¶</a></h2>
<p>Templates are authored in <a class="reference external" href="http://jinja.pocoo.org/docs/dev/templates/">jinja2</a>.
Drop a file with the <code class="docutils literal notranslate"><span class="pre">.j2</span></code> extension into the a templates directory, and send a pull request to this
repo. You can then reference it in the <code class="docutils literal notranslate"><span class="pre">notify</span></code> action as the <code class="docutils literal notranslate"><span class="pre">template</span></code>
variable by file name minus extension. Templates ending with <code class="docutils literal notranslate"><span class="pre">.html.j2</span></code> are
sent as HTML-formatted emails, all others are sent as plain text.</p>
<p>You can use <code class="docutils literal notranslate"><span class="pre">-t</span></code> or <code class="docutils literal notranslate"><span class="pre">--templates</span></code> cli argument to pass custom folder with your templates.</p>
<p>The following variables are available when rendering templates:</p>
<table border="1" class="docutils">
<thead>
<tr>
<th align="left">variable</th>
<th align="left">value</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><code>recipient</code></td>
<td align="left">email address</td>
</tr>
<tr>
<td align="left"><code>resources</code></td>
<td align="left">list of resources that matched the policy filters</td>
</tr>
<tr>
<td align="left"><code>event</code></td>
<td align="left">for CWE-push-based lambda policies, the event that triggered</td>
</tr>
<tr>
<td align="left"><code>action</code></td>
<td align="left"><code>notify</code> action that generated this SQS message</td>
</tr>
<tr>
<td align="left"><code>policy</code></td>
<td align="left">policy that triggered this notify action</td>
</tr>
<tr>
<td align="left"><code>account</code></td>
<td align="left">short name of the aws account</td>
</tr>
<tr>
<td align="left"><code>region</code></td>
<td align="left">region the policy was executing in</td>
</tr>
<tr>
<td align="left"><code>execution_start</code></td>
<td align="left">The time policy started executing</td>
</tr>
</tbody>
</table><p>The following extra global functions are available:</p>
<table border="1" class="docutils">
<thead>
<tr>
<th align="left">signature</th>
<th align="left">behavior</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><code>format_struct(struct)</code></td>
<td align="left">pretty print a json structure</td>
</tr>
<tr>
<td align="left"><code>resource_tag(resource, key)</code></td>
<td align="left">retrieve a tag value from a resource or return an empty string, aliased as get_resource_tag_value</td>
</tr>
<tr>
<td align="left"><code>format_resource(resource, resource_type)</code></td>
<td align="left">renders a one line summary of a resource</td>
</tr>
<tr>
<td align="left"><code>date_time_format(utc_str, tz_str='US/Eastern', format='%Y %b %d %H:%M %Z')</code></td>
<td align="left">customize rendering of an utc datetime string</td>
</tr>
<tr>
<td align="left"><code>seach(expression, value)</code></td>
<td align="left">jmespath search value using expression</td>
</tr>
<tr>
<td align="left"><code>yaml_safe(value)</code></td>
<td align="left">yaml dumper</td>
</tr>
</tbody>
</table><p>The following extra jinja filters are available:</p>
<table border="1" class="docutils">
<thead>
<tr>
<th align="left">filter</th>
<th align="left">behavior</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><code>utc_string&#124;date_time_format(tz_str='US/Pacific', format='%Y %b %d %H:%M %Z')</code></td>
<td align="left">pretty <a href="https://docs.python.org/2/library/datetime.html#strftime-strptime-behavior">format</a> the date / time</td>
</tr>
<tr>
<td align="left"><code>30&#124;get_date_time_delta</code></td>
<td align="left">Convert a time <a href="https://docs.python.org/2/library/datetime.html#datetime.timedelta">delta</a> like '30' days in the future, to a datetime string. You can also use negative values for the past.</td>
</tr>
</tbody>
</table></div>
<div class="section" id="developer-install-os-x-el-capitan">
<h2>Developer Install (OS X El Capitan)<a class="headerlink" href="#developer-install-os-x-el-capitan" title="Permalink to this headline">¶</a></h2>
<p>Clone the repository:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git clone https://github.com/cloud-custodian/cloud-custodian
</pre></div>
</div>
<p>Install dependencies (with virtualenv):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ virtualenv c7n_mailer
$ source c7n_mailer/bin/activate
$ cd tools/c7n_mailer
$ pip install -r requirements.txt
</pre></div>
</div>
<p>Install the extensions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">develop</span>
</pre></div>
</div>
</div>
<div class="section" id="testing-templates-and-recipients">
<h2>Testing Templates and Recipients<a class="headerlink" href="#testing-templates-and-recipients" title="Permalink to this headline">¶</a></h2>
<p>A <code class="docutils literal notranslate"><span class="pre">c7n-mailer-replay</span></code> entrypoint is provided to assist in testing email notifications
and templates. This script operates on an actual SQS message from cloud-custodian itself,
which you can either retrieve from the SQS queue or replicate locally. By default it expects
the message file to be base64-encoded, gzipped JSON, just like c7n sends to SQS. With the
<code class="docutils literal notranslate"><span class="pre">-p</span></code> | <code class="docutils literal notranslate"><span class="pre">--plain</span></code> argument, it will expect the message file to contain plain JSON.</p>
<p><code class="docutils literal notranslate"><span class="pre">c7n-mailer-replay</span></code> has three main modes of operation:</p>
<ul class="simple">
<li><p>With no additional arguments, it will render the template specified by the policy the
message is for, and actually send mail from the local machine as <code class="docutils literal notranslate"><span class="pre">c7n-mailer</span></code> would.
This only works with SES, not SMTP.</p></li>
<li><p>With the <code class="docutils literal notranslate"><span class="pre">-T</span></code> | <code class="docutils literal notranslate"><span class="pre">--template-print</span></code> argument, it will log the email addresses that would
receive mail, and print the rendered message body template to STDOUT.</p></li>
<li><p>With the <code class="docutils literal notranslate"><span class="pre">-d</span></code> | <code class="docutils literal notranslate"><span class="pre">--dry-run</span></code> argument, it will print the actual email body (including headers)
that would be sent, for each message that would be sent, to STDOUT.</p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="c7n-trailcreator.html" class="btn btn-neutral float-right" title="AWS Retroactive Tagging Resource Creators" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="c7n-policystream.html" class="btn btn-neutral float-left" title="c7n-policystream: Policy Changes from Git" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Capital One Services, LLC

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>