

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Azure Functions Support &mdash; Cloud Custodian  documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/c1_labs.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../_static/js/expand.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/expand.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Running against multiple subscriptions" href="multiplesubs.html" />
    <link rel="prev" title="Advanced Usage" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Cloud Custodian
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Cloud Custodian</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../filters.html">Generic Filters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../actions.html">Generic Actions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart/advanced.html">Advanced Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart/policyStructure.html">Example tag compliance policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview/glossary.html">Basic concepts and terms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview/deployment.html">Deployment</a></li>
</ul>
<p class="caption"><span class="caption-text">AWS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../aws/gettingstarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aws/examples/index.html">Example Policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aws/policy/index.html">Filters and Actions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aws/aws-modes.html">AWS Modes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aws/usage.html">Monitoring your environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aws/policy/lambda.html">Lambda Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aws/policy/mu.html">Mu - Lambda Lifecycle Management</a></li>
</ul>
<p class="caption"><span class="caption-text">Azure</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../gettingstarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../authentication.html">Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../authentication.html#azure-storage-access">Azure Storage access</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../policy/index.html">Policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../azure-modes.html">Azure Modes</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Advanced Usage</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Azure Functions Support</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#provision-options">Provision Options</a></li>
<li class="toctree-l3"><a class="reference internal" href="#execution-options">Execution Options</a></li>
<li class="toctree-l3"><a class="reference internal" href="#event-grid-functions">Event Grid Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#advanced-authentication-options">Advanced Authentication Options</a></li>
<li class="toctree-l3"><a class="reference internal" href="#management-groups-support">Management Groups Support</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#timer-triggered-functions">Timer triggered functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#event-triggered-functions">Event triggered functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#permissions">Permissions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="multiplesubs.html">Running against multiple subscriptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="bloboutput.html">Blob Storage Output</a></li>
<li class="toctree-l2"><a class="reference internal" href="appinsightslogging.html">App Insights Logging &amp; Metrics</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../contribute.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contribute.html#adding-new-azure-resources">Adding New Azure Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contribute.html#testing">Testing</a></li>
</ul>
<p class="caption"><span class="caption-text">GCP</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../gcp/gettingstarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gcp/gcp-modes.html">GCP Modes</a></li>
</ul>
<p class="caption"><span class="caption-text">Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tools/c7n-org.html">c7n-org: Multi Account Custodian Execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/c7n-policystream.html">c7n-policystream: Policy Changes from Git</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/c7n-mailer.html">c7n-mailer: Custodian Mailer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/c7n-trailcreator.html">AWS Retroactive Tagging Resource Creators</a></li>
</ul>
<p class="caption"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contribute.html">Contributing to Cloud Custodian</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/index.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/installing.html">Installing for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/tests.html">Testing for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/documentation.html">Documentation For Developers</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Cloud Custodian</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Advanced Usage</a> &raquo;</li>
        
      <li>Azure Functions Support</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="azure-functions-support">
<span id="azure-azurefunctions"></span><h1>Azure Functions Support<a class="headerlink" href="#azure-functions-support" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The Azure provider supports deploying policies into Azure Functions to allow
them to run inexpensively in your subscription.</p>
<p>Python support in Azure Functions V2 is in preview and this feature is still immature.</p>
<ul class="simple">
<li><p>Linux is currently the only supported operating system.</p></li>
<li><p>Python 3.6 is the only supported version.</p></li>
<li><p>Only Service Principal authentication is currently supported.</p></li>
</ul>
<p>Currently periodic (CRON) and Event Grid functions are supported, however consumption pricing is not
yet supported.</p>
</div>
<div class="section" id="provision-options">
<h2>Provision Options<a class="headerlink" href="#provision-options" title="Permalink to this headline">¶</a></h2>
<p>When deploying an Azure function the following ARM resources are required and created on demand if necessary:</p>
<ul class="simple">
<li><p>Storage (shared across functions)</p></li>
<li><p>Application Insights (shared across functions)</p></li>
<li><p>Application Service Plan (shared across functions with optional default auto scale rule)</p></li>
<li><p>Application Service (per function)</p></li>
</ul>
<p>Functions can be deployed in either a dedicated Application Service Plan (Basic, Standard or Premium) or in a Consumption plan.
More details on the different hosting models offered by Azure Functions can be found in the <a class="reference external" href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-scale">Azure Functions documentation</a>.
By default, we will run all Custodian policies using the Consumption hosting model. (i.e. skuTier=dynamic)
Linux Consumption is currently only available in the following regions: East Asia, East US, West Europe, and West US</p>
<p>A dedicated plan can service multiple Function Applications.  If you provide the same servicePlanName with all policies or
use the default name then only new Function Applications will be created during deployment, all using the same
shared plan resources.</p>
<p>You can enable default auto scaling option for your dedicated App Service Plan. Default option allows you
to specify minimum and maximum number of underlying VMs. Scaling is performed based on the average RAM usage.
App Service Plan will be scaled up if average RAM usage was more than 80% in the past 10 minutes.
This option is disabled by default.</p>
<p>Execution in Azure functions comes with a default set of configurations for the provisioned
resources. To override these settings you must set ‘provision-options’ with one of the following
keys:</p>
<ul class="simple">
<li><dl class="simple">
<dt>servicePlan</dt><dd><ul>
<li><p>name (default: cloud-custodian)</p></li>
<li><p>location (default: East US)</p></li>
<li><p>resourceGroupName (default: cloud-custodian)</p></li>
<li><p>skuTier (default: Dynamic) # consumption</p></li>
<li><p>skuName (default: Y1)</p></li>
<li><dl class="simple">
<dt>autoScale (optional):</dt><dd><ul>
<li><p>enabled (default: False)</p></li>
<li><p>minCapacity (default: 1)</p></li>
<li><p>maxCapacity (default: 1)</p></li>
<li><p>defaultCapacity (default: 1)</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>storageAccount</dt><dd><ul>
<li><p>name (default: custodian + sha256(resourceGroupName+subscription_id)[:8])</p></li>
<li><p>location (default: servicePlan location)</p></li>
<li><p>resourceGroupName (default: servicePlan resource group)</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>appInsights</dt><dd><ul>
<li><p>name (default: servicePlan resource group)</p></li>
<li><p>location (default: servicePlan location)</p></li>
<li><p>resourceGroupName (default: servicePlan name)</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>The location allows you to choose the region to deploy the resource group and resources that will be
provisioned. Application Insights has six available locations and thus can not always be in the same
region as the other resources: West US 2, East US, North Europe, South Central US, Southeast Asia, and
West Europe. The sku, skuCode, and workerSize correlate to scaling up the App Service Plan.</p>
<p>If specified resources already exist in the subscription (discoverable by resource group name and resource name), Cloud Custodian won’t make any changes (location, sku)
and will use existing resources as-is. If resource doesn’t exist, it will be provisioned using provided configuration.</p>
<p>If you have existing infrastructure, you can specify resource ids for the following items (instead of applying previous schema):</p>
<ul class="simple">
<li><p>storageAccount</p></li>
<li><p>servicePlan</p></li>
<li><p>appInsights</p></li>
</ul>
<p>If you provide resource ids, Cloud Custodian verifies that resource exists before function app provisioning. It returns an error if resource is missing.</p>
<p>An example on how to set the servicePlanName, accept defaults for the other values and enable default scaling:</p>
<p>This policy deploys dedicated Standard S2 App Service Plan with enabled auto scale rule for 1-3 VMs.
Default scaling rule scales app service plan if total RAM consumption is more than 80%.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">policies</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">stopped-vm</span>
    <span class="nt">mode</span><span class="p">:</span>
        <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">azure-periodic</span>
        <span class="nt">schedule</span><span class="p">:</span> <span class="s">&#39;0</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*&#39;</span>
        <span class="nt">provision-options</span><span class="p">:</span>
          <span class="nt">servicePlan</span><span class="p">:</span>
            <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">functionshost</span>
            <span class="nt">skuTier</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Standard</span>
            <span class="nt">skuName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">S2</span>
            <span class="nt">autoScale</span><span class="p">:</span>
              <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
              <span class="nt">minCapacity</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
              <span class="nt">maxCapacity</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
              <span class="nt">defaultCapacity</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
    <span class=" -Error"> </span><span class="nt">resource</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">azure.vm</span>
     <span class="nt">filters</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">instance-view</span>
        <span class="nt">key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">statuses[].code</span>
        <span class="nt">op</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">not-in</span>
        <span class="nt">value_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">swap</span>
        <span class="nt">value</span><span class="p">:</span> <span class="s">&quot;PowerState/running&quot;</span>
</pre></div>
</div>
<p>An example on how to set size and location as well:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">policies</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">stopped-vm</span>
    <span class="nt">mode</span><span class="p">:</span>
        <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">azure-periodic</span>
        <span class="nt">schedule</span><span class="p">:</span> <span class="s">&#39;0</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*&#39;</span>
        <span class="nt">provision-options</span><span class="p">:</span>
          <span class="nt">servicePlan</span><span class="p">:</span>
            <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">functionshost</span>
            <span class="nt">location</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">East US</span>
            <span class="nt">skuTier</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Standard</span>
            <span class="nt">skuName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">S1</span>
          <span class="nt">appInsights</span><span class="p">:</span>
            <span class="nt">location</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">East US</span>
          <span class="nt">storageAccount</span><span class="p">:</span>
            <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sampleaccount</span>
            <span class="nt">location</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">East US</span>
    <span class=" -Error"> </span><span class="nt">resource</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">azure.vm</span>
     <span class="nt">filters</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">instance-view</span>
        <span class="nt">key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">statuses[].code</span>
        <span class="nt">op</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">not-in</span>
        <span class="nt">value_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">swap</span>
        <span class="nt">value</span><span class="p">:</span> <span class="s">&quot;PowerState/running&quot;</span>
</pre></div>
</div>
<p>An example on how to use existing infrastructure:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">policies</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">stopped-vm</span>
    <span class="nt">mode</span><span class="p">:</span>
        <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">azure-periodic</span>
        <span class="nt">schedule</span><span class="p">:</span> <span class="s">&#39;0</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*&#39;</span>
        <span class="nt">provision-options</span><span class="p">:</span>
          <span class="nt">servicePlan</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/subscriptions/&lt;subscription_id&gt;/resourceGroups/cloud-custodian/providers/Microsoft.Web/serverFarms/existingResource</span>
          <span class="nt">appInsights</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/subscriptions/&lt;subscription_id&gt;/resourceGroups/cloud-custodian/providers/microsoft.insights/components/existingResource</span>
          <span class="nt">storageAccount</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/subscriptions/&lt;subscription_id&gt;/resourceGroups/cloud-custodian/providers/Microsoft.Storage/storageAccounts/existingResource</span>
    <span class=" -Error"> </span><span class="nt">resource</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">azure.vm</span>
     <span class="nt">filters</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">instance-view</span>
        <span class="nt">key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">statuses[].code</span>
        <span class="nt">op</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">not-in</span>
        <span class="nt">value_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">swap</span>
        <span class="nt">value</span><span class="p">:</span> <span class="s">&quot;PowerState/running&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="execution-options">
<h2>Execution Options<a class="headerlink" href="#execution-options" title="Permalink to this headline">¶</a></h2>
<p>Execution options are not required, but allow you to override defaults that would normally
be provided on the command line in non-serverless scenarios.</p>
<p>Common properties are:</p>
<ul class="simple">
<li><p>output_dir</p></li>
<li><p>cache_period</p></li>
<li><p>dryrun</p></li>
</ul>
<p>Output directory defaults to <cite>/tmp/&lt;random_uuid&gt;</cite> but you can point it to a Azure Blob Storage container instead</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">policies</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">stopped-vm</span>
    <span class="nt">mode</span><span class="p">:</span>
        <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">azure-periodic</span>
        <span class="nt">schedule</span><span class="p">:</span> <span class="s">&#39;0</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*&#39;</span>
        <span class="nt">provision-options</span><span class="p">:</span>
          <span class="nt">servicePlan</span><span class="p">:</span>
            <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">functionshost</span>
        <span class="nt">execution-options</span><span class="p">:</span>
          <span class="nt">output_dir</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">azure://yourstorageaccount.blob.core.windows.net/custodian</span>
    <span class=" -Error"> </span><span class="nt">resource</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">azure.vm</span>
     <span class="nt">filters</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">instance-view</span>
        <span class="nt">key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">statuses[].code</span>
        <span class="nt">op</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">not-in</span>
        <span class="nt">value_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">swap</span>
        <span class="nt">value</span><span class="p">:</span> <span class="s">&quot;PowerState/running&quot;</span>
</pre></div>
</div>
<p>More details on Blob Storage output are at <a class="reference internal" href="bloboutput.html#azure-bloboutput"><span class="std std-ref">Blob Storage Output</span></a></p>
</div>
<div class="section" id="event-grid-functions">
<h2>Event Grid Functions<a class="headerlink" href="#event-grid-functions" title="Permalink to this headline">¶</a></h2>
<p>Currently, support for event grid functions is at the subscription level and can listen to write and delete
events. When deploying an event grid function, an Event Grid Subscription is created that triggers the Azure Function
when any event is triggered in the subscription. Cloud custodian filters to the events you passed to your policy and
ignores all other events.</p>
<p>In order to subscribe on an event you need to provide the resource provider and the action, or provide the string
of one of the <a class="reference external" href="https://github.com/cloud-custodian/cloud-custodian/blob/master/tools/c7n_azure/c7n_azure/azure_events.py">shortcuts</a>.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">policies</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">tag-key-vault-creator</span>
      <span class="nt">resource</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">azure.keyvault</span>
      <span class="nt">mode</span><span class="p">:</span>
        <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">azure-event-grid</span>
        <span class="nt">events</span><span class="p">:</span> <span class="p p-Indicator">[{</span>
<span class="nt">            resourceProvider</span><span class="p">:</span> <span class="s">&#39;Microsoft.KeyVault/vaults&#39;</span><span class="p p-Indicator">,</span>
<span class="nt">            event</span><span class="p">:</span> <span class="s">&#39;write&#39;</span>
          <span class="p p-Indicator">}]</span>
      <span class="nt">filters</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="s">&quot;tag:CreatorEmail&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">null</span>
      <span class="nt">actions</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">auto-tag-user</span>
          <span class="nt">tag</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">CreatorEmail</span>
</pre></div>
</div>
</div>
<div class="section" id="advanced-authentication-options">
<h2>Advanced Authentication Options<a class="headerlink" href="#advanced-authentication-options" title="Permalink to this headline">¶</a></h2>
<p>By default the function is both deployed and executed with the credentials and subscription ID you have configured
for the custodian CLI.  You may optionally provide environment variables to use exclusively at function execution time
which also allow you to target your policy towards a subscription ID different than the one to which you are deploying.</p>
<p>The following variables will be obeyed if set:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>AZURE_FUNCTION_TENANT_ID
AZURE_FUNCTION_CLIENT_ID
AZURE_FUNCTION_CLIENT_SECRET
AZURE_FUNCTION_SUBSCRIPTION_ID
</pre></div>
</div>
<p>These will be used for function execution, but the normal service principal credentials will still be
used for deployment.</p>
<p>You may provide the service principal but omit the subscription ID if you wish.</p>
</div>
<div class="section" id="management-groups-support">
<h2>Management Groups Support<a class="headerlink" href="#management-groups-support" title="Permalink to this headline">¶</a></h2>
<p>You can deploy Azure Functions targeting all subscriptions that are part of specified Management Group.</p>
<p>The following variable allows you to specify Management Group name:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>AZURE_FUNCTION_MANAGEMENT_GROUP_NAME
</pre></div>
</div>
<p>It can be used with Function specific Service Principal credentials described before. Management Group environment variable has the highest priority, so <cite>AZURE_FUNCTION_SUBSCRIPTION_ID</cite> will be ignored.</p>
<div class="section" id="timer-triggered-functions">
<h3>Timer triggered functions<a class="headerlink" href="#timer-triggered-functions" title="Permalink to this headline">¶</a></h3>
<p>When Management Groups option is used with periodic mode, Cloud Custodian deploys a single Azure Function App with multiple Azure Functions following single subscription per function rule.</p>
</div>
<div class="section" id="event-triggered-functions">
<h3>Event triggered functions<a class="headerlink" href="#event-triggered-functions" title="Permalink to this headline">¶</a></h3>
<p>When Management Groups option is used with event mode, Cloud Custodian deploys single Azure Function. It creates Event Grid subscription for each Subscription in Management Group delivering events to a single Azure Storage Queue.</p>
</div>
<div class="section" id="permissions">
<h3>Permissions<a class="headerlink" href="#permissions" title="Permalink to this headline">¶</a></h3>
<p>Service Principal used at the Functions runtime required to have appropriate level of permission in each target subscription.</p>
<p>Service Principal used to provision Azure Functions required to have permissions to access Management Groups. If SP doesn’t have <cite>MG Reader</cite> permissions in any child subscription these subscriptions won’t be a part of Cloud Custodian Azure Function deployment process.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="multiplesubs.html" class="btn btn-neutral float-right" title="Running against multiple subscriptions" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="Advanced Usage" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Capital One Services, LLC

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>